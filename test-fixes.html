<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D World Stability Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
        }
        #test-container {
            width: 800px;
            height: 600px;
            border: 2px solid #333;
            margin: 20px 0;
            position: relative;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            margin: 0 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            background: #333;
            border-radius: 4px;
        }
        .error {
            background: #d32f2f;
        }
        .success {
            background: #388e3c;
        }
    </style>
</head>
<body>
    <h1>3D World Render Stability Test</h1>
    
    <div class="controls">
        <button onclick="initializeTest()">Initialize 3D World</button>
        <button onclick="reinitializeTest()">Re-initialize (Test Blinking)</button>
        <button onclick="disposeTest()">Dispose World</button>
    </div>
    
    <div id="status" class="status">Ready to test...</div>
    
    <div id="test-container"></div>
    
    <div class="controls">
        <h3>Test Results:</h3>
        <ul>
            <li id="result-init">Initialization: Not tested</li>
            <li id="result-reinit">Re-initialization: Not tested</li>
            <li id="result-materials">Material compatibility: Not tested</li>
            <li id="result-disposal">Proper disposal: Not tested</li>
        </ul>
    </div>

    <script type="module">
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js';
        
        let scene, camera, renderer, world;
        let initCount = 0;
        let isInitialized = false;

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = 'status ' + type;
        }

        function updateResult(testId, status, success = true) {
            const resultEl = document.getElementById(testId);
            resultEl.textContent = status;
            resultEl.style.color = success ? '#4CAF50' : '#f44336';
        }

        // Simplified Enhanced3DWorld for testing
        class TestEnhanced3DWorld {
            constructor(scene) {
                this.scene = scene;
                this.isInitialized = false;
            }

            async init() {
                if (this.isInitialized) {
                    console.log('TestEnhanced3DWorld: Already initialized, skipping...');
                    updateResult('result-reinit', 'Re-initialization: PASSED (Properly prevented)', true);
                    return;
                }

                console.log('TestEnhanced3DWorld: Creating world...');
                this.isInitialized = true;

                // Test material compatibility (the fix we applied)
                try {
                    const stoneGeometry = new THREE.BoxGeometry(1, 2, 0.5);
                    const stoneMaterial = new THREE.MeshStandardMaterial({ 
                        color: 0x696969,
                        roughness: 0.8  // This should work with MeshStandardMaterial
                    });
                    const stone = new THREE.Mesh(stoneGeometry, stoneMaterial);
                    stone.position.set(2, 1, 0);
                    this.scene.add(stone);
                    updateResult('result-materials', 'Material compatibility: PASSED (No roughness errors)', true);
                } catch (error) {
                    updateResult('result-materials', 'Material compatibility: FAILED - ' + error.message, false);
                }

                // Add some basic terrain
                const planeGeometry = new THREE.PlaneGeometry(20, 20, 32, 32);
                const planeMaterial = new THREE.MeshLambertMaterial({ color: 0x4a5d23 });
                const plane = new THREE.Mesh(planeGeometry, planeMaterial);
                plane.rotation.x = -Math.PI / 2;
                this.scene.add(plane);

                // Add some trees
                for (let i = 0; i < 10; i++) {
                    const treeGeometry = new THREE.ConeGeometry(0.5, 2, 8);
                    const treeMaterial = new THREE.MeshLambertMaterial({ color: 0x228B22 });
                    const tree = new THREE.Mesh(treeGeometry, treeMaterial);
                    tree.position.set(
                        Math.random() * 10 - 5,
                        1,
                        Math.random() * 10 - 5
                    );
                    this.scene.add(tree);
                }
            }

            dispose() {
                // Clean up resources
                this.isInitialized = false;
                console.log('TestEnhanced3DWorld: Disposed');
            }
        }

        window.initializeTest = async function() {
            try {
                initCount++;
                updateStatus('Initializing 3D world...', 'info');

                // Prevent multiple initializations (the fix we applied)
                if (isInitialized || renderer) {
                    updateStatus('Already initialized, skipping...', 'info');
                    updateResult('result-init', 'Initialization: PASSED (Prevented multiple init)', true);
                    return;
                }

                isInitialized = true;

                const container = document.getElementById('test-container');
                
                // Scene setup
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x87CEEB);

                // Camera setup
                camera = new THREE.PerspectiveCamera(75, 800/600, 0.1, 1000);
                camera.position.set(5, 5, 5);
                camera.lookAt(0, 0, 0);

                // Renderer setup
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(800, 600);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                container.appendChild(renderer.domElement);

                // Lighting
                const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
                scene.add(ambientLight);

                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(10, 10, 5);
                directionalLight.castShadow = true;
                scene.add(directionalLight);

                // Initialize world
                world = new TestEnhanced3DWorld(scene);
                await world.init();

                // Animation loop
                function animate() {
                    requestAnimationFrame(animate);
                    renderer.render(scene, camera);
                }
                animate();

                updateStatus('3D world initialized successfully!', 'success');
                updateResult('result-init', 'Initialization: PASSED (Count: ' + initCount + ')', true);

            } catch (error) {
                updateStatus('Error: ' + error.message, 'error');
                updateResult('result-init', 'Initialization: FAILED - ' + error.message, false);
            }
        };

        window.reinitializeTest = async function() {
            try {
                updateStatus('Testing re-initialization...', 'info');
                await initializeTest(); // This should be prevented
            } catch (error) {
                updateStatus('Re-initialization error: ' + error.message, 'error');
                updateResult('result-reinit', 'Re-initialization: FAILED - ' + error.message, false);
            }
        };

        window.disposeTest = function() {
            try {
                updateStatus('Disposing 3D world...', 'info');
                
                if (world) {
                    world.dispose();
                    world = null;
                }

                if (renderer) {
                    const container = document.getElementById('test-container');
                    if (renderer.domElement && container.contains(renderer.domElement)) {
                        container.removeChild(renderer.domElement);
                    }
                    renderer.dispose();
                    renderer = null;
                }

                scene = null;
                camera = null;
                isInitialized = false;

                updateStatus('3D world disposed successfully!', 'success');
                updateResult('result-disposal', 'Proper disposal: PASSED', true);

            } catch (error) {
                updateStatus('Disposal error: ' + error.message, 'error');
                updateResult('result-disposal', 'Proper disposal: FAILED - ' + error.message, false);
            }
        };
    </script>
</body>
</html>